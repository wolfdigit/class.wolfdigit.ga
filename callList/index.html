<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>叫號機</title>
  
  <style>
    #sortable { /*list-style-type: none;*/ border-spacing: 0 5px; }
    #sortable > li { background-color: azure; }
    #sortable > li.active { background-color: aqua; }
    #sortable > li > .col:first-child { border-top-left-radius: 0.4ex; border-bottom-left-radius: 0.4ex; }
    #sortable > li > .col:last-child { border-top-right-radius: 0.4ex; border-bottom-right-radius: 0.4ex; }
      
    #sortable { display: table; }
    #sortable > li { display: table-row; }
    .col { display: table-cell; padding: 5px; }
  </style>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>
    function encodeList() {
      var encoded='';
      $('#sortable > li').each(function (number, element) {
        if (number>0) encoded += "\n";
        $( '.col', element ).each(function (number, element) {
          if (number==0) return;
          if (number>1) encoded += "\t";
          encoded += $(element).text().trim();
        });
      });
      return encoded;
    }
    
    function decodeList(encoded) {
      $('#sortable').empty();
      lines = encoded.split("\n");
      lines.forEach(function(obj, idx) {
        nodeRow = $('<li>');
        nodeRow.append('<span class="col">#'+(idx+1)+':</span>')

        cols = obj.split("\t");
        cols.forEach(function(obj, idx) {
          nodeCol = $('<span>').addClass('col');
          nodeCol.text(obj);
          nodeRow.append(nodeCol);
        });

        $('#sortable').append(nodeRow);
      });
      if (pw0==null||pw==pw0) {
        $('#sortable > li').css('cursor', 'move');
      }
    }
  </script>
  <script>
    var cacheFile=null;
    var loading=false;
    function downloadData_real(action=null) {
      //url = 'https://docs.google.com/a/lssh.tp.edu.tw/spreadsheets/d/1dScK1gGfviRrR8cZD12ZQFA8bsgJr-RuAQygSqr6faA/export?format=csv&id=1dScK1gGfviRrR8cZD12ZQFA8bsgJr-RuAQygSqr6faA&gid=1446184689';
      //url = 'https://docs.google.com/spreadsheets/d/1dScK1gGfviRrR8cZD12ZQFA8bsgJr-RuAQygSqr6faA/pub?output=csv';
      url = 'http://wolfdigit.ga/callList/ajax.php';
      ajaxBack = function(data) {
        cacheFile = data;
        if (action!=null) {
          action();
        }
      };
      $.get(url, ajaxBack);
      /*
      $.ajax({
        type: "GET",
        url: url,
        //data: "",
        //complete: ajaxBack
        crossDomain: true,
        dataType: "text"
      }).done(ajaxBack).always(function(a){console.log(a);});
      */
    }
    function downloadData(id="id", type="type", action=null) {
      if (cacheFile==null) {
        if (!loading) {
          loading = true;
          downloadData_real(function() {
            loading = false;
            //downloadData(id, type, action);
          });
        }
        setTimeout(function() {
          downloadData(id, type, action);
        }, 100);
        return;
      }
      lines = cacheFile.split("\n");
      lines.reverse();
      retv = null;
      lines.some(function(obj, idx) {
        cols = obj.trim().split(",");
        if (cols[2]==id && cols[3]==type) {
          retv = decodeURIComponent(cols[4]);
          return true;
        }
      });
      if (action!=null) {
        action(retv);
      }
    }
    
    function uploadData(id="id", type="type", data=null, action=null) {
      if (!(pw0==null||pw==pw0)) return;
      cacheFile = null;
      //url = 'https://docs.google.com/a/lssh.tp.edu.tw/forms/d/e/1FAIpQLSes7I2sVrDrjNYAXIhLIcpyD1n5o6RYIAkm2Dk3BHqgljjkwg/formResponse';
      url = 'http://wolfdigit.ga/callList/ajax.php';
      postData = {'entry.422715126': id, 'entry.673226051': type, 'entry.657943876': encodeURIComponent(data)};
      $.ajax({
        type: "POST",
        url: url,
        data: postData
      }).always(function(data){
        if (action!=null) action();
      });
    }
  </script>
  <script>
    var id=null;
    var pw=null;
    var pw0=null;
    function sortedCallback(event, ui) {
      $('#text').val(encodeList());
      uploadData(id, "data", $('#text').val(), function() {
        downloadData(id, "data", function(encoded) {
          $('#text').val(encoded);
          decodeList(encoded);
        });
      });
    }
    
    function showNum(num) {
      $('#sortable > li.active').removeClass('active');
      $('#sortable > li:eq('+(num-1)+')').addClass('active');
    }
    function getNum() {
      downloadData(id, "call", function(num) {
        $('#callNum').val(num);
        showNum(num);
      });
    }
    function setNum() {
      uploadData(id, "call", $('#callNum').val(), getNum);
    }

    function update() {
      cacheFile=null;
      downloadData(id, "data", function(encoded) {
        if (encoded==null) encoded="";
        $('#text').val(encoded);
        decodeList(encoded);
      });
      downloadData(id, "title", function(title) {
        $('#title').text(title);
        $('#setTitle').val(title);
      });
      getNum();
    }
    
    var eta=0;
    var timer;
    function countDown() {
      if (eta<=0) {
        update();
        eta = Math.floor(Math.random()*5000+5000);
      }
      $('#countTxt').text(Math.floor(eta/100)/10);
      timer = setTimeout(countDown, 100);
      eta -= 100;
    }
    
    $(function() {
      line = window.location.hash.substr(1);
      segs = line.split("&");
      segs.forEach(function(seg) {
        if (seg.substr(0,3)=="pw=") {
          pw = seg.substr(3);
        }
        else {
          id = seg;
        }
      });
      
      
      if (id!="") {
        downloadData(id, "pw", function(pw1) {
          pw0 = pw1;
          if (pw0==null||pw==pw0) {
            $('#setPW').val(pw0);
            $('#edit').show();
            $( "#sortable" ).sortable({stop: sortedCallback});
            $( "#sortable" ).disableSelection();
            update();
          }
          else {
            $('#countdown').show();
            countDown();
          }
        });
      }
      $('#buttImp').click(function() {
        decodeList($('#text').val());
        sortedCallback();
      });
      $('#buttrand').click(function() {
        lines = $('#text').val().split("\n");
        newlines = '';
        while (lines.length>0) {
          rndIdx = Math.floor(Math.random()*lines.length);
          newlines += lines[rndIdx];
          if (lines.length>1) newlines+='\n';
          lines.splice(rndIdx,1);
        }
        $('#text').val(newlines);
        decodeList($('#text').val());
        sortedCallback();
      });
      
      $('#buttTitle').click(function() {
        uploadData(id, "title", $('#setTitle').val(), function() {
          downloadData(id, "title", function(title) {
            $('#title').text(title);
          });
        });
      });
      $('#buttPW').click(function() {
        uploadData(id, "pw", $('#setPW').val(), function() {
          window.location.reload();
        });
      });
      
      $('#buttSetNum').click(setNum);
      $('#buttprev').click(function(){ $('#callNum').val(parseInt($('#callNum').val())-1); setNum(); });
      $('#buttnext').click(function(){ $('#callNum').val(parseInt($('#callNum').val())+1); setNum(); });
      
      $('#countStop').click(function() {clearTimeout(timer);});
      $('#countNow').click(function() {eta=0;});
    });
  </script>
</head>
<body>
  <h1 id="title"></h1>
  <ol id="sortable">
    <li><span class="col">you have to specify id</span></li>
  </ol>
  
  <div id="edit" style="display:none;">
    call to: <button id="buttprev">prev</button><input type="number" id="callNum" value="0"><button id="buttSetNum">set</button><button id="buttnext">next</button>
    <br>
    <textarea id="text"></textarea>
    <button id="buttImp">import</button>
    <button id="buttrand">randomize</button>
    <br>
    <input type="text" id="setTitle" placeholder="title">
    <button id="buttTitle">set title</button>
    <br>
    <input type="text" id="setPW" placeholder="pw">
    <button id="buttPW">set pw</button>
    
    <div style="position:fixed; top:10px; right:10px">
      <div id="qrcode"></div>
      <div id="qrcodeTxt"></div>
    </div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script>
      function showQRCode() {
        url = document.location.protocol +"//"+ document.location.hostname + document.location.pathname + "#" + id;
        $('#qrcode').qrcode(url);
        $('#qrcodeTxt').text(url);
      }
      $(function(){ setTimeout(showQRCode, 2000); });
    </script>
  </div>
  <div id="countdown" style="display:none;">
    refresh: <span id="countTxt" style="display:inline-block; width:2em">@@</span>secs<br>
    <button id="countNow">now</button> <button id="countStop">stop</button>
  </div>
</body>
</html>
